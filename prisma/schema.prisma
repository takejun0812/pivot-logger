// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ------------------------------------------------------
// Enums
// ------------------------------------------------------

enum ProjectStatus {
  ACTIVE
  ARCHIVED
}

enum CycleStatus {
  DRAFT
  RUNNING
  REVIEW
  COMPLETED
}

enum PivotDecision {
  PENDING
  PERSEVERE
  PIVOT
  KILL
}

enum AuthorType {
  AI
  MENTOR
}

// ------------------------------------------------------
// Models
// ------------------------------------------------------

model Project {
  id          String   @id @default(uuid())
  userId      String
  title       String
  mission     String
  status      ProjectStatus @default(ACTIVE)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  cycles      PivotCycle[]

  @@index([userId])
}

model PivotCycle {
  id          String   @id @default(uuid())
  projectId   String
  
  phase       Int      
  
  hypothesis  String?  @db.Text
  action      String?  @db.Text
  result      String?  @db.Text
  learning    String?  @db.Text

  status      CycleStatus   @default(DRAFT)
  decision    PivotDecision @default(PENDING)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  feedbacks   Feedback[]

  // ↓↓↓ 修正箇所：ここが正しい場所です ↓↓↓
  // @@unique([projectId, phase])  <-- これを削除しました（重複OKにするため）
  
  @@index([projectId]) // プロジェクトIDで検索しやすくする
  @@index([phase])     // フェーズ番号で検索しやすくする
}

model Feedback {
  id          String   @id @default(uuid())
  cycleId     String
  
  content     String   @db.Text
  authorType  AuthorType

  createdAt   DateTime @default(now())

  cycle       PivotCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  
  @@index([cycleId])
}
